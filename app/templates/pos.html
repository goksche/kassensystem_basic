<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Kasse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* Grid für gleich große, eckige Felder */
    .pill-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
      gap:.6rem;
    }
    .pill{
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      height:56px;                 /* EINHEITLICHE HÖHE */
      padding:0 .75rem;
      font-size:1rem;
      line-height:1.2;
      border-radius:0;             /* ECKIG */
      border:1px solid rgba(0,0,0,.1);
      user-select:none;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill.svc{ background:#0d6efd; color:#fff; }      /* Primary */
    .pill.prd{ background:#6c757d; color:#fff; }      /* Secondary */

    .cart-row + .cart-row{ border-top:1px solid #eee; }
    .qty-btn{ width:2.1rem; }
  </style>
</head>
<body class="bg-light">
  {% include "_header.html" %}

  <div class="container py-3">
    <div class="row g-3">
      <!-- Sortiment -->
      <div class="col-12 col-lg-7">
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title mb-3">Dienstleistungen</h5>
            <div class="pill-grid">
              {% for s in services %}
                <div class="pill svc"
                     data-type="service"
                     data-id="{{ s.id }}"
                     data-name="{{ s.name }}"
                     data-price="{{ '%.2f' % (s.basispreis or 0) }}"
                     data-tax="{{ s.steuer_code or 'S1' }}"
                     data-grp="{{ s.warengruppe or 'DL' }}">
                  {{ s.name }} • {{ '%.2f' % (s.basispreis or 0) }} CHF
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <h5 class="card-title mb-3">Produkte</h5>
            <div class="pill-grid">
              {% for p in produkte %}
                <div class="pill prd"
                     data-type="produkt"
                     data-id="{{ p.id }}"
                     data-name="{{ p.name }}"
                     data-price="{{ '%.2f' % (p.verkaufspreis or 0) }}"
                     data-tax="{{ p.steuer_code or 'S1' }}"
                     data-grp="{{ p.warengruppe or 'PR' }}">
                  {{ p.name }} • {{ '%.2f' % (p.verkaufspreis or 0) }} CHF
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Warenkorb & Zahlung -->
      <div class="col-12 col-lg-5">
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title mb-3">Warenkorb</h5>

            <div id="cart_list" class="mb-3"></div>

            <div class="d-flex justify-content-between">
              <span class="fw-semibold">Total</span>
              <span class="fw-bold fs-5"><span id="cart_total">0.00</span> CHF</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <h5 class="card-title mb-3">Zahlung</h5>

            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="pay_method" id="pay_bar" value="bar" checked>
              <label class="form-check-label" for="pay_bar">Bar</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="pay_method" id="pay_karte" value="karte">
              <label class="form-check-label" for="pay_karte">Karte</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="pay_method" id="pay_twint" value="twint">
              <label class="form-check-label" for="pay_twint">Twint</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="pay_method" id="pay_kombi" value="kombi">
              <label class="form-check-label" for="pay_kombi">Kombi</label>
            </div>

            <div id="kombi_fields" class="row g-2 mt-2" style="display:none">
              <div class="col-12 col-sm-4">
                <label class="form-label mb-0">Bar (CHF)</label>
                <input type="number" class="form-control" id="kombi_bar" step="0.05" min="0" value="0">
              </div>
              <div class="col-12 col-sm-4">
                <label class="form-label mb-0">Karte (CHF)</label>
                <input type="number" class="form-control" id="kombi_karte" step="0.05" min="0" value="0">
              </div>
              <div class="col-12 col-sm-4">
                <label class="form-label mb-0">Twint (CHF)</label>
                <input type="number" class="form-control" id="kombi_twint" step="0.05" min="0" value="0">
              </div>
              <div class="col-12">
                <small id="kombi_hint" class="text-muted">Summe muss dem Total entsprechen.</small>
              </div>
            </div>

            <div class="d-grid mt-3">
              <button id="btn_pay" class="btn btn-primary btn-lg">Bezahlen</button>
            </div>

            <!-- Fallback (wird vom Script gefüllt, falls Fetch fehlschlägt) -->
            <input type="hidden" id="hidden_items" name="items">
            <input type="hidden" id="hidden_payment" name="payment">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script>
  (function () {
    // Interner Warenkorb
    const cart = [];

    // Helfer
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);
    const num = (v) => Number((v ?? "0").toString().replace(",", ".")) || 0;
    const fmt = (v) => (Number(v || 0).toFixed(2));

    function recalc() {
      let html = "";
      cart.forEach((it, i) => {
        html += `
          <div class="d-flex justify-content-between align-items-center py-2 cart-row">
            <div class="me-2">
              <div class="fw-semibold">${it.name}</div>
              <div class="small text-muted">${it.type} • ${fmt(it.price)} CHF</div>
            </div>
            <div class="d-flex align-items-center gap-1">
              <button class="btn btn-sm btn-outline-secondary qty-btn" data-i="${i}" data-op="-">-</button>
              <span class="px-2">${it.qty}</span>
              <button class="btn btn-sm btn-outline-secondary qty-btn" data-i="${i}" data-op="+">+</button>
              <button class="btn btn-sm btn-outline-danger ms-2 rm-btn" data-i="${i}">×</button>
            </div>
          </div>`;
      });
      $("#cart_list").innerHTML = html || '<div class="text-muted">Warenkorb ist leer.</div>';

      const total = cart.reduce((s, it) => s + Number(it.price) * Number(it.qty), 0);
      $("#cart_total").textContent = fmt(total);

      $$(".qty-btn").forEach(b => b.addEventListener("click", (e) => {
        const i = Number(e.currentTarget.dataset.i);
        const op = e.currentTarget.dataset.op;
        if (op === "+") cart[i].qty++;
        if (op === "-" && cart[i].qty > 1) cart[i].qty--;
        recalc();
      }));
      $$(".rm-btn").forEach(b => b.addEventListener("click", (e) => {
        const i = Number(e.currentTarget.dataset.i);
        cart.splice(i, 1);
        recalc();
      }));
    }

    function addItem(pill) {
      const type = (pill.dataset.type || "").toLowerCase();
      const id = Number(pill.dataset.id || 0);
      const name = pill.dataset.name || "";
      const price = num(pill.dataset.price);
      const tax = pill.dataset.tax || "S1";
      const grp = pill.dataset.grp || (type === "service" ? "DL" : "PR");
      if (id <= 0) return;

      const found = cart.find(it => it.type === type && it.id === id);
      if (found) { found.qty++; recalc(); return; }

      cart.push({ type, id, name, price, qty: 1, tax_code: tax, grp: grp });
      recalc();
    }

    // Sortiment anklickbar
    $$(".pill").forEach(p => p.addEventListener("click", () => addItem(p)));

    // Kombi Toggle
    function toggleKombi() {
      const method = document.querySelector('input[name="pay_method"]:checked')?.value || "bar";
      $("#kombi_fields").style.display = (method === "kombi") ? "" : "none";
    }
    $$('input[name="pay_method"]').forEach(r => r.addEventListener("change", toggleKombi));
    toggleKombi();

    // Bezahlen
    $("#btn_pay").addEventListener("click", async (ev) => {
      ev.preventDefault();
      if (!cart.length) { alert("Warenkorb ist leer."); return; }

      const total = Number(cart.reduce((s,it)=>s + Number(it.price)*Number(it.qty), 0).toFixed(2));
      const method = document.querySelector('input[name="pay_method"]:checked')?.value || "bar";

      let amounts = { bar:0, karte:0, twint:0 };
      if (method === "kombi") {
        amounts.bar   = Number(num($("#kombi_bar").value).toFixed(2));
        amounts.karte = Number(num($("#kombi_karte").value).toFixed(2));
        amounts.twint = Number(num($("#kombi_twint").value).toFixed(2));
        const sum = Number((amounts.bar + amounts.karte + amounts.twint).toFixed(2));
        if (sum !== total) {
          $("#kombi_hint").classList.remove("text-muted");
          $("#kombi_hint").classList.add("text-danger");
          $("#kombi_hint").textContent = `Summe (${sum.toFixed(2)} CHF) muss dem Total (${total.toFixed(2)} CHF) entsprechen.`;
          return;
        } else {
          $("#kombi_hint").classList.add("text-muted");
          $("#kombi_hint").classList.remove("text-danger");
          $("#kombi_hint").textContent = "Summe muss dem Total entsprechen.";
        }
      } else if (method === "bar") {
        amounts.bar = total;
      } else if (method === "karte") {
        amounts.karte = total;
      } else if (method === "twint") {
        amounts.twint = total;
      }

      const items = cart.map(it => ({
        type: it.type, id: it.id, qty: it.qty,
        price: Number(it.price),
        total: Number((it.price * it.qty).toFixed(2)),
        tax_code: it.tax_code || "S1",
        grp: it.grp || (it.type === "service" ? "DL" : "PR"),
        name: it.name || ""
      }));

      const payload = { items, payment: { method, amounts } };

      try {
        const res = await fetch("/pos/checkout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          alert((data && data.error) ? data.error : "Fehler beim Bezahlen.");
          return;
        }

        // Belegvorschau
        const html = await fetch("/beleg/preview", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            items: data.items,
            total: data.total,
            payment: data.payment
          })
        }).then(r => r.text());
        const w = window.open("", "_blank");
        w.document.open(); w.document.write(html); w.document.close();

        // Warenkorb leeren
        cart.splice(0, cart.length);
        recalc();
      } catch (err) {
        // Fallback: klassischer Form-POST
        $("#hidden_items").value = JSON.stringify(items);
        $("#hidden_payment").value = JSON.stringify({ method, amounts });
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "/pos/checkout";
        form.appendChild($("#hidden_items"));
        form.appendChild($("#hidden_payment"));
        document.body.appendChild(form);
        form.submit();
      }
    });

    // initial
    recalc();
  })();
  </script>
</body>
</html>
