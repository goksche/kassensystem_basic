{% extends "base.html" %}

{% block content %}
<h1 class="text-xl font-semibold mb-4">Kasse</h1>

<div class="grid grid-cols-1 xl:grid-cols-3 gap-6">

  <!-- Services -->
  <section class="xl:col-span-1 bg-white border rounded">
    <div class="px-4 py-3 border-b font-semibold">Services</div>
    <div class="divide-y">
      {% for s in services %}
        <div class="px-4 py-3 flex items-center gap-3">
          <div class="flex-1">
            <div class="font-medium">{{ s.name }}</div>
            <div class="text-xs text-gray-500">
              Dauer: {{ s.dauer_min }} min • Preis: CHF {{ '%.2f'|format(s.basispreis) }} • Steuer: {{ s.steuer_code }}
            </div>
            {% if s.kategorie %}
              <div class="text-xs text-gray-400">Kategorie: {{ s.kategorie }}</div>
            {% endif %}
          </div>
          <button type="button"
                  class="text-sm px-2 py-1 rounded border bg-white hover:bg-gray-50"
                  data-type="service"
                  data-id="s-{{ s.id }}"
                  data-name="{{ s.name }}"
                  data-tax="{{ s.steuer_code }}"
                  data-price="{{ '%.2f'|format(s.basispreis) }}">
            Hinzufügen
          </button>
        </div>
      {% else %}
        <div class="px-4 py-6 text-sm text-gray-500">Keine aktiven Services.</div>
      {% endfor %}
    </div>
  </section>

  <!-- Produkte -->
  <section class="xl:col-span-1 bg-white border rounded">
    <div class="px-4 py-3 border-b font-semibold">Produkte</div>
    <div class="divide-y">
      {% for p in produkte %}
        <div class="px-4 py-3 flex items-center gap-3">
          <div class="flex-1">
            <div class="font-medium">{{ p.name }}</div>
            <div class="text-xs text-gray-500">
              VK: CHF {{ '%.2f'|format(p.verkaufspreis) }}
              {% if p.einkaufspreis is not none %} • EK: CHF {{ '%.2f'|format(p.einkaufspreis) }}{% endif %}
              • Lager: {{ p.lagerbestand or 0 }} • Steuer: {{ p.steuer_code }}
            </div>
          </div>
          <button type="button"
                  class="text-sm px-2 py-1 rounded border bg-white hover:bg-gray-50"
                  data-type="produkt"
                  data-id="p-{{ p.id }}"
                  data-name="{{ p.name }}"
                  data-tax="{{ p.steuer_code }}"
                  data-price="{{ '%.2f'|format(p.verkaufspreis) }}">
            Hinzufügen
          </button>
        </div>
      {% else %}
        <div class="px-4 py-6 text-sm text-gray-500">Keine aktiven Produkte.</div>
      {% endfor %}
    </div>
  </section>

  <!-- Warenkorb / Totals -->
  <section class="xl:col-span-1 bg-white border rounded">
    <div class="px-4 py-3 border-b font-semibold">Warenkorb</div>

    <div id="cart-empty" class="p-4 text-sm text-gray-500">Noch keine Positionen. Füge links etwas hinzu.</div>

    <div id="cart-list" class="divide-y hidden"></div>

    <div class="p-4 border-t space-y-3">
      <div class="grid grid-cols-3 gap-3 items-end">
        <label class="text-sm">Rabatt (CHF)</label>
        <input id="disc-abs" type="number" step="0.05" min="0" class="col-span-2 border rounded px-2 py-1" value="0">
      </div>
      <div class="grid grid-cols-3 gap-3 items-end">
        <label class="text-sm">Rabatt (%)</label>
        <input id="disc-pct" type="number" step="0.5" min="0" max="100" class="col-span-2 border rounded px-2 py-1" value="0">
      </div>
      <div class="grid grid-cols-3 gap-3 items-end">
        <label class="text-sm">Trinkgeld (CHF)</label>
        <input id="tip" type="number" step="0.05" min="0" class="col-span-2 border rounded px-2 py-1" value="0">
      </div>

      <div class="pt-3 border-t space-y-1 text-sm">
        <div class="flex justify-between"><span>Zwischensumme</span><span id="sum-sub">CHF 0.00</span></div>
        <div class="flex justify-between text-gray-600"><span>Rabatt</span><span id="sum-disc">– CHF 0.00</span></div>
        <div class="flex justify-between text-gray-600"><span>Trinkgeld</span><span id="sum-tip">CHF 0.00</span></div>
        <div class="flex justify-between"><span>Gesamt</span><span id="sum-total" class="font-semibold">CHF 0.00</span></div>
      </div>

      <div id="tax-breakdown" class="text-xs text-gray-600"></div>

      <div class="pt-3 flex gap-2">
        <button id="btn-clear" type="button" class="px-3 py-2 rounded border bg-white hover:bg-gray-50">Warenkorb leeren</button>
        <!-- >>> Der gewünschte Button zum Buchen <<< -->
        <button id="btn-book"  type="button" class="px-3 py-2 rounded bg-black text-white hover:bg-gray-800 disabled:opacity-40" disabled>
          Buchen
        </button>
      </div>
      <div id="book-msg" class="text-xs text-emerald-700 mt-2 hidden"></div>
    </div>
  </section>
</div>

<script>
(function(){
  const TAX = {"CH-7.7":0.077, "CH-2.6":0.026, "CH-0":0.0};

  const cart = new Map();

  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  const elEmpty   = $("#cart-empty");
  const elList    = $("#cart-list");
  const elSub     = $("#sum-sub");
  const elDisc    = $("#sum-disc");
  const elTip     = $("#sum-tip");
  const elTotal   = $("#sum-total");
  const elTax     = $("#tax-breakdown");
  const inDiscAbs = $("#disc-abs");
  const inDiscPct = $("#disc-pct");
  const inTip     = $("#tip");
  const btnClear  = $("#btn-clear");
  const btnBook   = $("#btn-book");
  const msg       = $("#book-msg");

  let lastTotal = 0;

  function fmt(n){ return "CHF " + n.toFixed(2); }

  function render(){
    if (cart.size === 0){
      elEmpty.classList.remove("hidden");
      elList.classList.add("hidden");
      elList.innerHTML = "";
      updateTotals();
      return;
    }
    elEmpty.classList.add("hidden");
    elList.classList.remove("hidden");

    elList.innerHTML = "";
    cart.forEach(item => {
      const line = document.createElement("div");
      line.className = "px-4 py-3 flex items-center gap-3";
      line.innerHTML = `
        <div class="flex-1">
          <div class="font-medium">${item.name}</div>
          <div class="text-xs text-gray-500">Steuer: ${item.tax} • Einzel: ${fmt(item.price)}</div>
        </div>
        <div class="flex items-center gap-1">
          <button class="px-2 py-1 border rounded" data-act="dec" data-key="${item.key}">−</button>
          <input class="w-12 text-center border rounded py-1" data-act="qty" data-key="${item.key}" value="${item.qty}">
          <button class="px-2 py-1 border rounded" data-act="inc" data-key="${item.key}">+</button>
        </div>
        <div class="w-28 text-right">${fmt(item.price * item.qty)}</div>
        <button class="ml-2 px-2 py-1 border rounded bg-white hover:bg-gray-50" data-act="rm" data-key="${item.key}">Entfernen</button>
      `;
      elList.appendChild(line);
    });

    updateTotals();
  }

  function addItem({id,name,price,tax}){
    const key = id;
    const ex = cart.get(key);
    if (ex){ ex.qty += 1; }
    else   { cart.set(key, {key,id,name,price:parseFloat(price),tax,qty:1}); }
    render();
  }

  function updateTotals(){
    let sub = 0;
    const taxBuckets = {};
    cart.forEach(it=>{
      const line = it.price * it.qty;
      sub += line;
      const rate = TAX[it.tax] ?? 0;
      taxBuckets[it.tax] = (taxBuckets[it.tax] || 0) + (line * rate / (1 + rate));
    });

    const discAbs = Math.max(0, parseFloat(inDiscAbs.value || "0"));
    const discPct = Math.max(0, Math.min(100, parseFloat(inDiscPct.value || "0")));
    const discPctAmt = sub * (discPct/100);
    const disc = Math.min(sub, discAbs + discPctAmt);

    const tip = Math.max(0, parseFloat(inTip.value || "0"));
    const total = Math.max(0, sub - disc) + tip;

    elSub.textContent   = fmt(sub);
    elDisc.textContent  = "– " + fmt(disc);
    elTip.textContent   = fmt(tip);
    elTotal.textContent = fmt(total);
    lastTotal = total;

    const lines = Object.keys(taxBuckets).sort().map(code=>{
      return `<div class="flex justify-between"><span>Steueranteil ${code}</span><span>${fmt(taxBuckets[code])}</span></div>`;
    });
    elTax.innerHTML = lines.length ? `<div class="mt-2 space-y-1">${lines.join("")}</div>` : "";

    btnBook.disabled = cart.size === 0 || total <= 0;
  }

  // Delegation: Artikel hinzufügen & Cart-Buttons
  document.addEventListener("click", (e)=>{
    const addBtn = e.target.closest("button[data-type]");
    if (addBtn){
      addItem({
        id: addBtn.dataset.id,
        name: addBtn.dataset.name,
        price: addBtn.dataset.price,
        tax: addBtn.dataset.tax
      });
    }
    const actBtn = e.target.closest("button[data-act]");
    if (actBtn){
      const key = actBtn.dataset.key;
      const item = cart.get(key);
      if (!item) return;
      const act = actBtn.dataset.act;
      if (act === "inc") item.qty += 1;
      if (act === "dec") item.qty = Math.max(1, item.qty - 1);
      if (act === "rm")  cart.delete(key);
      render();
    }
  });

  // Menge manuell
  document.addEventListener("change", (e)=>{
    const inp = e.target.closest('input[data-act="qty"]');
    if (!inp) return;
    const key = inp.dataset.key;
    const item = cart.get(key);
    if (!item) return;
    const v = parseInt(inp.value || "1", 10);
    item.qty = Math.max(1, isNaN(v) ? 1 : v);
    render();
  });

  [inDiscAbs, inDiscPct, inTip].forEach(el => el.addEventListener("input", updateTotals));
  btnClear.addEventListener("click", ()=>{ cart.clear(); render(); });

  // >>> BUCHEN <<<
  btnBook.addEventListener("click", async ()=>{
    if (cart.size === 0 || lastTotal <= 0) return;

    // Payload für optionales Backend
    const items = Array.from(cart.values()).map(x=>({
      id: x.id, name: x.name, price: x.price, qty: x.qty, tax: x.tax, type: x.id.startsWith("s-") ? "service" : "produkt"
    }));
    const payload = {
      items,
      discount_abs: parseFloat(inDiscAbs.value || "0"),
      discount_pct: parseFloat(inDiscPct.value || "0"),
      tip: parseFloat(inTip.value || "0"),
      total: lastTotal,
      payment: [{method:"BAR", amount:lastTotal}]
    };

    // Versuche, an /pos/checkout zu posten; wenn nicht vorhanden -> clientseitiger Abschluss
    let successText = "";
    try {
      const res = await fetch("/pos/checkout", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      if (res.ok){
        const data = await res.json().catch(()=>({}));
        successText = data && data.receipt_number ? `Beleg ${data.receipt_number} gebucht.` : "Buchung erfolgreich.";
      }
    } catch(e){ /* offline fallback */ }

    if (!successText){
      successText = "Buchung erfolgreich (Demo).";
    }
    msg.textContent = successText;
    msg.classList.remove("hidden");

    // Warenkorb leeren nach Buchung
    cart.clear();
    inDiscAbs.value = "0";
    inDiscPct.value = "0";
    inTip.value = "0";
    render();

    // kurze visuelle Bestätigung
    setTimeout(()=>{ msg.classList.add("hidden"); }, 3000);
  });

  render();
})();
</script>
{% endblock %}
